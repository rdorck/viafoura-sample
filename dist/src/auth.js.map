{"version":3,"sources":["../../src/auth.js"],"names":["window","addEventListener","content","document","querySelector","spinner","getElementById","style","display","userProfile","apiUrl","requestedScopes","webAuth","auth0","WebAuth","domain","AUTH0_DOMAIN","clientID","AUTH0_CLIENT_ID","redirectUri","AUTH0_CALLBACK_URL","audience","responseType","scope","leeway","dialog","homeView","loginView","commentsView","profileView","homeBtn","signupBtn","loginBtn","logoutBtn","profileBtn","event","preventDefault","signup","getUserProfile","login","logout","connection","email","val","password","err","swal","type","text","message","authorize","setSession","authResult","expiresAt","JSON","stringify","expiresIn","Date","getTime","scopes","localStorage","setItem","accessToken","idToken","removeItem","getItem","title","client","userInfo","profile","displayProfile","isAuthenticated","parse","authenticate","parseHash","error","location","hash","console","log","status","innerHTML","userHasScopes","nickname","src","picture","savedScopes","grantedScopes","split","i","length","indexOf","authAPI","endpoint","secured","method","callback","url","xhr","XMLHttpRequest","open","setRequestHeader","onload","responseText","statusText","send"],"mappings":"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","file":"auth.js","sourcesContent":["window.addEventListener('load', () => {\n  let content = document.querySelector('.content');\n  let spinner = document.getElementById('loading');\n\n  content.style.display = 'block';\n  spinner.style.display = 'none';\n\n  var userProfile;\n  var apiUrl = 'http://localhost:3001/api';\n  var requestedScopes = 'openid profile read:messages write:messages';\n\n  // Initialize Auth0 object\n  var webAuth = new auth0.WebAuth({\n    domain: AUTH0_DOMAIN,\n    clientID: AUTH0_CLIENT_ID,\n    redirectUri: AUTH0_CALLBACK_URL,\n    audience: \"https://\" + AUTH0_DOMAIN + '/userinfo',\n    responseType: \"token id_token\",\n    scope: requestedScopes,\n    leeway: 60\n  });\n\n  let dialog = document.querySelector('dialog');\n\n  let homeView = document.getElementById('home-view');\n  let loginView = document.getElementById('login-view');\n  let commentsView = document.getElementById('comments-view');\n  let profileView = document.getElementById('profile-view');\n\n  let homeBtn = document.getElementById('btn-home');\n  let signupBtn = document.getElementById('btn-signup');\n  let loginBtn = document.getElementById('btn-login');\n  let logoutBtn = document.getElementById('btn-logout');\n  let profileBtn = document.getElementById('btn-profile');\n\n  commentsView.style.display = 'none';\n\n  // Home Listener\n  homeBtn.addEventListener('click', () => {\n    profileView.style.display = 'none';\n    loginView.style.display = 'none';\n    homeView.style.display = 'inline-block';\n  });\n\n  // Signup Listener\n  signupBtn.addEventListener('click', event => {\n    event.preventDefault();\n    spinner.style.display = 'inline-block';\n\n    signup();\n  });\n\n  // Profile Listener\n  profileBtn.addEventListener('click', () => {\n    loginView.style.display = 'none';\n    profileView.style.display = 'inline-block';\n\n    getUserProfile();\n  });\n\n  // Login Listener\n  loginBtn.addEventListener('click', login());\n\n  // Logout Listener\n  logoutBtn.addEventListener('click', logout());\n\n  // Signup\n  function signup () {\n    webAuth.signup({\n      connection: 'Username-Password-Authentication',\n      email: document.getElementById('email').val(),\n      password: document.getElementById('pwd').val()\n    }, function (err) {\n      if (err) {\n        return swal({\n          type: 'error',\n          text: err.message\n        });\n      }\n\n      return swal({\n        type: 'success',\n        text: 'Successfully created an account!'\n      });\n    });\n  }\n\n  // Login with Auth0\n  function login () {\n    webAuth.authorize();\n  }\n\n  /**\n   * Sets localStorage Cookie for Auth0 session\n   *\n   * @param authResult\n   */\n  function setSession (authResult) {\n    var expiresAt = JSON.stringify(\n      authResult.expiresIn * 1000 + new Date().getTime()\n    );\n\n    /*\n     * If there is a value on the `scope` param from the authResult,\n     * use it to set scopes in the session for the user. Otherwise\n     * use the scopes as requested. If no scopes were requested,\n     * set it to nothing\n     */\n    const scopes = authResult.scope || requestedScopes || '';\n\n    localStorage.setItem('access_token', authResult.accessToken);\n    localStorage.setItem('id_token', authResult.idToken);\n    localStorage.setItem('expires_at', expiresAt);\n    localStorage.setItem('scopes', JSON.stringify(scopes));\n  }\n\n  // Removes localStorage set by Auth0\n  function logout () {\n    localStorage.removeItem('access_token');\n    localStorage.removeItem('id_token');\n    localStorage.removeItem('expires_at');\n    localStorage.removeItem('scopes');\n\n    display();\n  }\n\n  // Call to get user profile and display\n  function getUserProfile () {\n    if (!userProfile) {\n      var accessToken = localStorage.getItem('access_token');\n\n      if (!accessToken) {\n        swal({\n          type: 'warning',\n          title: 'Missing Data',\n          text: 'Access token must exist to fetch user profile'\n        });\n      }\n\n      webAuth.client.userInfo(accessToken, (err, profile) => {\n        if (profile) {\n          userProfile = profile;\n          displayProfile();\n        }\n      });\n    } else {\n      displayProfile();\n    }\n  }\n\n  /**\n   * Verifies expires_at Auth0 token\n   *\n   * @returns {boolean}\n   */\n  function isAuthenticated () {\n    var expiresAt = JSON.parse(localStorage.getItem('expires_at'));\n    return new Date().getTime() < expiresAt;\n  }\n\n  // Handles actual authentication via Auth0\n  function authenticate () {\n    webAuth.parseHash((error, authResult) => {\n\n      if (authResult && authResult.accessToken && authResult.idToken) {\n        swal({\n          type: 'success',\n          text: 'User is authenticated'\n        });\n\n        window.location.hash = '';\n        console.log(authResult);\n\n        //dialog.close(); // closes authentication dialog\n        setSession(authResult); // sets localStorage\n\n        homeView.style.display = 'inline-block';\n        //logoutBtn.style.display = 'inline-block';\n        //commentsView.style.display = 'inline-block';\n      } else if (error) {\n        //dialog.showModal();\n        homeView.style.display = 'inline-block';\n        loginView.style.display = 'inline-block';\n        console.log(error);\n\n        swal({\n          type: 'error',\n          title: 'Authentication Error',\n          text: 'There was a problem authenticating given user'\n        });\n      }\n    });\n  }\n\n  // Style Login form depending on authentication status\n  function display () {\n    var status = document.querySelector('#status');\n\n    if (isAuthenticated()) {\n      status.innerHTML = 'You are logged in!';\n    } else {\n      status.innerHTML = 'Please login to access your account';\n    }\n\n    if (!isAuthenticated || !userHasScopes(['write:messages'])) {\n      commentsView.style.display = 'none';\n    } else {\n      commentsView.style.display = 'inline-block';\n    }\n  }\n\n  // Displays profile-view populated with user data\n  function displayProfile () {\n    document.querySelector('#profile-view .nickname')\n      .innerHTML = userProfile.nickname;\n\n    document.querySelector('#profile-view .full-profile')\n      .innerHTML = JSON.stringify(userProfile, null, 2);\n\n    document.querySelector('#profile-view img')\n      .src = userProfile.picture;\n  }\n\n  /**\n   * Verifies users allowed scopes\n   *\n   * @param scopes\n   * @returns {boolean}\n   */\n  function userHasScopes(scopes) {\n    var savedScopes = JSON.parse(localStorage.getItem('scopes'));\n    if (!savedScopes) return false;\n    var grantedScopes = savedScopes.split(' ');\n    for (var i = 0; i < scopes.length; i++) {\n      if (grantedScopes.indexOf(scopes[i]) < 0) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  /**\n   * Make API call to Auth0\n   * \n   * @param endpoint\n   * @param secured\n   * @param method\n   * @param callback\n   */\n  function authAPI (endpoint, secured, method, callback) {\n    var url = apiUrl + endpoint;\n    var xhr = new XMLHttpRequest();\n\n    xhr.open(method, url);\n\n    if (secured) {\n      xhr.setRequestHeader(\n        'Authorization',\n        'Bearer ' + localStorage.getItem('access_token')\n      );\n    }\n\n    xhr.onload = function () {\n      if (xhr.status == 200) {\n        var message = JSON.parse(xhr.responseText).message;\n        callback(null, message);\n      } else {\n        callback(xhr.statusText);\n      }\n    }\n\n    xhr.send();\n  }\n\n  authenticate();\n  display();\n});"]}